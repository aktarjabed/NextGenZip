name: Android CI - Connected Tests & Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Emulator / API level used for instrumentation tests (API 31 recommended)
  ANDROID_API_LEVEL: 31
  ANDROID_EMULATOR_IMAGE: "system-images;android-${{ env.ANDROID_API_LEVEL }};google_apis;x86"
  EMULATOR_DEVICE: "Pixel_3a_API_${{ env.ANDROID_API_LEVEL }}"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx3g"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        id: gradle-cache
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
            ~/.m2/repository
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties') }}-${{ hashFiles('**/*.gradle*', '**/*.kts') }}
          restore-keys: |
            gradle-cache-${{ runner.os }}-

      - name: Install Android SDK components
        uses: android-actions/setup-sdk@v2
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          components: |
            platform-tools
            emulator
            build-tools;33.0.2
            platforms;android-${{ env.ANDROID_API_LEVEL }}
            system-images;android-${{ env.ANDROID_API_LEVEL }};google_apis;x86
          ndk: '21.4.7075529'
          cache: true

      - name: Create and start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          target: google_apis
          arch: x86
          emulator-options: -no-window -no-audio -no-boot-anim
          force-avd-creation: true
          script: |
            # Wait for fully booted device
            adb wait-for-device
            adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            adb devices

      - name: Ensure emulator is available (quick check)
        run: adb shell getprop ro.build.version.sdk

      - name: Run connected Android tests (instrumentation)
        run: |
          echo "Running instrumentation tests..."
          ./gradlew connectedAndroidTest --no-daemon --stacktrace
        continue-on-error: false
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
        # Capture test output (may exist under app/build/outputs/androidTest-results)
      - name: Upload instrumentation test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instrumentation-test-results
          path: |
            app/build/reports/androidTests/connected/*
            app/build/outputs/androidTest-results/connected/*
            app/build/test-results/*
          # keep only latest for debugging
          retention-days: 7

      - name: Run lint and build
        run: |
          echo "Running lint and assemble..."
          ./gradlew lint --no-daemon --stacktrace || true
          ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: Publish test summary (optional)
        if: always()
        run: |
          echo "==== Build finished ===="
          if [ -d "app/build/reports/androidTests/connected" ]; then
            echo "Instrumentation reports available:"
            ls -la app/build/reports/androidTests/connected || true
          fi
          if [ -d "app/build/reports/lint-results" ]; then
            echo "Lint reports available:"
            ls -la app/build/reports/lint-results || true
          fi
