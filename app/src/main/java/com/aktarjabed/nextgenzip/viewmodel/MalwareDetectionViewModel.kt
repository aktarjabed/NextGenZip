package com.aktarjabed.nextgenzip.viewmodel

import android.app.Application
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.viewModelScope
import com.aktarjabed.nextgenzip.security.MalwareDetectionService
import com.aktarjabed.nextgenzip.security.QuarantineManager
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File

data class MalwareUiState(
    val isScanning: Boolean = false,
    val lastScanResult: MalwareDetectionService.ScanResult? = null,
    val riskScore: Int = 0,
    val quarantinedFiles: List<QuarantineManager.QuarantineEntry> = emptyList(),
    val scanHistory: List<ScanHistoryItem> = emptyList(),
    val error: String? = null
)

data class ScanHistoryItem(
    val fileName: String,
    val timestamp: Long,
    val result: String,
    val riskLevel: String
)

class MalwareDetectionViewModel(application: Application) : AndroidViewModel(application) {
    private val _uiState = MutableStateFlow(MalwareUiState())
    val uiState: StateFlow<MalwareUiState> = _uiState

    fun scanFile(file: File) {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(
                isScanning = true,
                error = null
            )

            try {
                val result = MalwareDetectionService.scanFileLocal(file)
                val riskScore = MalwareDetectionService.calculateRiskScore(result)

                val historyItem = ScanHistoryItem(
                    fileName = file.name,
                    timestamp = System.currentTimeMillis(),
                    result = when (result) {
                        is MalwareDetectionService.ScanResult.Safe -> "SAFE"
                        is MalwareDetectionService.ScanResult.Suspicious -> "SUSPICIOUS"
                        is MalwareDetectionService.ScanResult.Malware -> "MALWARE"
                        is MalwareDetectionService.ScanResult.Error -> "ERROR"
                    },
                    riskLevel = when {
                        riskScore >= 80 -> "CRITICAL"
                        riskScore >= 60 -> "HIGH"
                        riskScore >= 40 -> "MEDIUM"
                        riskScore >= 20 -> "LOW"
                        else -> "SAFE"
                    }
                )

                _uiState.value = _uiState.value.copy(
                    isScanning = false,
                    lastScanResult = result,
                    riskScore = riskScore,
                    scanHistory = (_uiState.value.scanHistory + historyItem).takeLast(50)
                )
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    isScanning = false,
                    error = "Scan failed: ${e.message}"
                )
            }
        }
    }

    fun refreshQuarantine() {
        viewModelScope.launch {
            try {
                val files = QuarantineManager.getQuarantinedFiles(getApplication())
                _uiState.value = _uiState.value.copy(
                    quarantinedFiles = files
                )
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    error = "Failed to load quarantine: ${e.message}"
                )
            }
        }
    }

    fun restoreFromQuarantine(quarantinePath: String, restorePath: String) {
        viewModelScope.launch {
            try {
                val result = QuarantineManager.restoreFromQuarantine(quarantinePath, restorePath)
                result.onSuccess {
                    _uiState.value = _uiState.value.copy(
                        quarantinedFiles = _uiState.value.quarantinedFiles.filter {
                            it.quarantinePath != quarantinePath
                        }
                    )
                }
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    error = "Restore failed: ${e.message}"
                )
            }
        }
    }

    fun deleteFromQuarantine(quarantinePath: String) {
        viewModelScope.launch {
            try {
                QuarantineManager.deleteFromQuarantine(quarantinePath)
                _uiState.value = _uiState.value.copy(
                    quarantinedFiles = _uiState.value.quarantinedFiles.filter {
                        it.quarantinePath != quarantinePath
                    }
                )
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    error = "Delete failed: ${e.message}"
                )
            }
        }
    }
}
